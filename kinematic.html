<!doctype html>
<html>
    <head>
        <meta charset="utf-8"/>
    </head>
	<body>
		<canvas id="canvas" style="border: 1px solid black;"></canvas>
        <div>
            <input type="range" min="0" max="100" step="0.1" value="15" id="factorP" /><br />
            <input type="range" min="0" max="20" step="0.1" value="0" id="factorI" /><br />
            <input type="range" min="0" max="20" step="0.1" value="0" id="factorD" /><br />
            <p id="message"></p>
        </div>
	</body>
    <script type="module">
        import Vector from './Vector.js';
        import Pantograph from './Pantograph.js';

        // localhost:8080/kinematic.html

        let ws;
        const canvas = document.getElementById("canvas"),
              context = canvas.getContext("2d"),
              message = document.getElementById("message");
        canvas.width = 1000;
        canvas.height = 600;
        canvas.onmousemove = function(event) {
            upperPanto.target.x = event.pageX-canvas.offsetLeft;
            upperPanto.target.y = event.pageY-canvas.offsetTop;
            upperPanto.target.subtract(upperPanto.base);
            upperPanto.inverseKinematics();

            if(!ws) {
                upperPanto.drawOpLimits(context);
                upperPanto.draw(context);
                return;
            }
            ws.send(JSON.stringify({
                'angles': {
                0: upperPanto.targetAngleR,
                1: upperPanto.targetAngleL-Math.PI
            }}));
        };
        const base = new Vector(canvas.width*0.5, 50),
              upperPanto = new Pantograph(base),
              lowerPanto = new Pantograph(base),
              pidSliders = [
                  document.getElementById('factorP'),
                  document.getElementById('factorI'),
                  document.getElementById('factorD')
              ];

        ws = new WebSocket('ws://' + window.location.hostname + ':' + window.location.port + window.location.pathname + window.location.search);
        ws.onopen = function(event) {
            console.log('Connection open');
        }
        ws.onclose = function(event) {
            console.log('Connection closed');
        }
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            upperPanto.baseAngleL = (data.angles[1])+Math.PI;
            upperPanto.baseAngleR = (data.angles[0]);
            upperPanto.forwardKinematics();
            upperPanto.pointerAngle = upperPanto.middleAngleR+data.angles[4];

            lowerPanto.baseAngleL = (data.angles[3])+Math.PI;
            lowerPanto.baseAngleR = (data.angles[2]);
            lowerPanto.forwardKinematics();
            lowerPanto.pointerAngle = lowerPanto.middleAngleR+data.angles[5];

            message.innerText = data.angles;
        }
        ws.onerror = function(event) {

        }

        function pidUpdate(index, event) {
            const angles = {};
            angles[6+index] = parseFloat(event.target.value);
            ws.send(JSON.stringify({'angles': angles}));
        }
        pidSliders[0].oninput = pidUpdate.bind(this, 0);
        pidSliders[1].oninput = pidUpdate.bind(this, 1);
        pidSliders[2].oninput = pidUpdate.bind(this, 2);

        if(ws)
            window.setInterval(function() {
                upperPanto.forwardKinematics();
                context.strokeStyle = 'black';
                upperPanto.drawOpLimits(context);
                context.strokeStyle = 'green';
                lowerPanto.draw(context);
                context.strokeStyle = 'red';
                upperPanto.draw(context);
            }, 10);
    </script>
</html>
