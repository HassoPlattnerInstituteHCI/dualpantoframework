<!doctype html>
<html>
    <head>
        <meta charset="utf-8"/>
    </head>
	<body>
		<canvas id="canvas" style="border: 1px solid black;"></canvas>
        <div id="message"></div>
	</body>
    <script type="module">
        import Vector from './Vector.js';
        import Pantograph from './Pantograph.js';

        // localhost:8080/kinematic.html

        let ws;
        const canvas = document.getElementById("canvas"),
              context = canvas.getContext("2d"),
              message = document.getElementById("message");
        canvas.width = 1000;
        canvas.height = 600;
        canvas.onmousemove = function(event) {
            upperPanto.target.x = event.pageX-canvas.offsetLeft;
            upperPanto.target.y = event.pageY-canvas.offsetTop;
            upperPanto.target.subtract(upperPanto.base);
            upperPanto.inverseKinematics();

            if(!ws) {
                upperPanto.drawOpLimits(context);
                upperPanto.draw(context);
                return;
            }
            const data = JSON.stringify({
                'angles': [
                upperPanto.targetAngleR,
                upperPanto.targetAngleL-Math.PI
            ], 'forces': [
                0,
                0
            ]});
            ws.send(data);
        };
        const upperPanto = new Pantograph(canvas.width),
              lowerPanto = new Pantograph(canvas.width),
              encoderStepsPerTurn = 5540;

        ws = new WebSocket('ws://' + window.location.hostname + ':' + window.location.port + window.location.pathname + window.location.search);
        ws.onopen = function(event) {
            console.log('Connection open');
        }
        ws.onclose = function(event) {
            console.log('Connection closed');
        }
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            upperPanto.baseAngleL = (data.angles[1])+Math.PI;
            upperPanto.baseAngleR = (data.angles[0]);
            upperPanto.forwardKinematics();
            upperPanto.pointerAngle = upperPanto.middleAngleR+data.angles[4];

            lowerPanto.baseAngleL = (data.angles[3])+Math.PI;
            lowerPanto.baseAngleR = (data.angles[2]);
            lowerPanto.forwardKinematics();
            lowerPanto.pointerAngle = lowerPanto.middleAngleR+data.angles[5];
        }
        ws.onerror = function(event) {

        }

        if(ws)
            window.setInterval(function() {
                upperPanto.forwardKinematics();
                context.strokeStyle = 'black';
                upperPanto.drawOpLimits(context);
                context.strokeStyle = 'green';
                lowerPanto.draw(context);
                context.strokeStyle = 'red';
                upperPanto.draw(context);
                // message.innerText = [panto.baseAngleL, panto.baseAngleR, panto.targetAngleL, panto.targetAngleR];
            }, 10);
    </script>
</html>
