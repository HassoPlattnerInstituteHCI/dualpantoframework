<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>dualpanto Visual-Debugger</title>


    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">


    <!-- Custom styles for this template -->
    <style>
      body {
        padding-top: 54px;
      }
      .btn{
        margin-bottom: 20px;
      }
      #history{
        padding-left: 0px;
      }
      .history-item{
        list-style-type: none;
        font-size: 5pt;
        color: lightskyblue;
      }
      .history-item-move{
        list-style-type: none;
        font-size: 5pt;
        color: lightcoral;
      }
      .history-item-say{
        list-style-type: none;
        font-size: 5pt;
        color: green;
      }
      @media (min-width: 992px) {
        body {
          padding-top: 56px;
        }
      }

    </style>

  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">dualpantoVis<sup> beta</sup></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
    </nav>
    <script src="js/jquery.min.js"></script>
    <script src="js/snap.svg-min.js" type="text/javascript"></script>

    <!-- Page Content -->
    <div class="container">
      <div class="row">
        <div class="col-lg-3 text-right">
            <h3 class="mt-5">controller</h3>
            <button type="button" id="grab-upper" class="btn btn-outline-success" data-toggle="button">Grab Upper</button><br>
            <button type="button" id="grab-lower" class="btn btn-outline-primary" data-toggle="button">Grab Lower</button><br>
              <div class="form-row">
                <div class="col-sm-8">
                  <input type="text" class="form-control" id="text-input" placeholder="Say text input">
                </div>
                <div class="col-sm-4">
                  <button type="button" id="text-input-submit" class="btn btn-info">Send</button>
                </div>
              </div>
            <!-- <button type="submit" id="createVirtualDevice" class="btn btn-info">Create Virtual Device</button><br> -->
        </div>
        <div class="col-lg-5 text-center">
          <h3 class = 'mt-5'>glyph</h3>
          <p id = "status"></p>
          <div class="slidecontainer">
            <!-- <input type="range" min="-1000" max="1000" value="50" class="slider" id="myRange">
            <input type="range" min="-1000" max="1000" value="50" class="slider" id="myRange2"> -->
          </div>
          <center>
           <svg width="300" height="300" id="svg"></svg>
           <svg width="300" height="300" id="newSvg">
             <g id="canvas" transform="translate(150 50) scale(1)">
              <g id="lower-panto">
                  <line id="lower-inner-left" />
                  <line id="lower-inner-right" />
                  <line id="lower-outer-right" />
                  <line id="lower-outer-left" />
                  <circle id="lower-base-left" />
                  <circle id="lower-base-right" />
                  <circle id="lower-endeffector" />
                  <line id="lower-handle-angle" />
                </g>
              <g id="upper-panto">
                <line id="upper-inner-left" />
                <line id="upper-inner-right" />
                <line id="upper-outer-right" />
                <line id="upper-outer-left" />
                <circle id="upper-base-left" />
                <circle id="upper-base-right" />
                <circle id="upper-endeffector" />
                <line id="upper-handle-angle" />
              </g>
             </g>
           </svg>
          </center>
        </div>
        <div class="col-lg-3 text-left">
          <h3 class="mt-5">status</h3>
          websocket : <span id = "status-websocket" class="badge badge-warning">Not Connected</span><br>
          serial : <span id = "status-serial" class="badge badge-warning">Data not comming</span><br>
          virtualpanto : <span id = "status-mirror" class="badge badge-secondary">No Kinematics</span><br>
          <h3 class="mt-5">log history</h3>
          <ul id="history"></ul>
        </div>
      </div>
    </div>
    <script src="js/Vector.js"></script>
    <script src="js/graphics.js" type="text/javascript"></script>
    <script>
      const ws = new WebSocket('ws://' + window.location.hostname + ':' + window.location.port + window.location.pathname + window.location.search);
        ws.onopen = function(event) {
            console.log('Connection open');
            document.getElementById('status-websocket').innerText = 'Connected';
            document.getElementById('status-websocket').className = 'badge badge-success';
            //TODO: Scan device to load multiple instance of pantos.
            const packet = {
              type: 'createVirtualDevice'
            };
            ws.send(JSON.stringify(packet));
        }
        ws.onclose = function(event) {
            console.log('Connection closed');
            document.getElementById('status-websocket').innerText = 'Disconnected';
            document.getElementById('status-websocket').className = 'badge badge-danger';
        }
        ws.onmessage = function(event) {
            // document.getElementById('status-serial').innerText = 'Receiving';
            document.getElementById('status-serial').className = 'badge badge-success';
            let node = document.createElement('li');
            const data = JSON.parse(event.data);
            node.className = 'history-item';
            const panto = (data.index == 0) ? UpperPanto : LowerPanto;
            switch(data.type) {
                case 'handleMoved':
                    node.className = 'history-item-move'
                    // TODO use data.port
                    panto.goalX = data.position.x;
                    panto.goalY = data.position.y;
                    // TODO use data.position.r
                    flushGlyph();
                    break;
                case 'moveHandleTo':
                    // TODO
                    if(data.position){
                      panto.targetX = -data.position.x;
                      panto.targetY = -data.position.y;
                      panto.pointingAngle = data.position.r;
                      panto.inverseKinematicsNumeric(panto.targetX,panto.targetY);
                      flushGlyph();
                    }
                    break;
                case 'saySpeak':
                    node.className = 'history-item-say'
                    break;
            }
            let textnode = document.createTextNode(event.data);
            node.appendChild(textnode);
            let history = document.getElementById('history');
            history.appendChild(node);
            if(history.childNodes.length>10){
              history.removeChild(history.childNodes[0]);
            }
        }
        ws.onerror = function(event) {
        }
        $("#createVirtualDevice").on('click', ()=>{
          const packet = {
            type: 'createVirtualDevice'
          };
          ws.send(JSON.stringify(packet));
        });
        $("#grab-upper").on('click', ()=>{
          if($("#grab-lower").hasClass('active'))
            $("#grab-lower").toggleClass('active');
        });
        $("#grab-lower").on('click', ()=>{
          if($("#grab-upper").hasClass('active'))
            $("#grab-upper").toggleClass('active');
        });
        $('#text-input').keypress(function(event){
          if(event.keyCode == 13){
            $('#text-input-submit').click();
          }
        });
        $("#text-input-submit").on('click', ()=>{
          if($("#text-input").val()){
            const packet = {
              type: 'inputText',
              text: $("#text-input").val()
            };
            ws.send(JSON.stringify(packet));
            $("#text-input").val('');
          }
        });
        let canvas = document.getElementById('svg');
        let isMouseDown = false;
        canvas.onmousedown = () => {isMouseDown = true;}
        canvas.onmouseup = () => {isMouseDown = false;}
        canvas.onmousemove = function(e){
          if(isMouseDown){
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left; //x position within the element.
            const y = e.clientY - rect.top;  //y position within the element.
            if($("#grab-upper").hasClass('active')){
              UpperPanto.targetX = -x+150;
              UpperPanto.targetY = y - 50;
              UpperPanto.inverseKinematicsNumeric(UpperPanto.targetX,UpperPanto.targetY);
              flushGlyph();
              const packet = {
                type: 'handleMoved',
                port: 'virtual0', // TODO
                index: 0,
                position: {
                  x: -UpperPanto.targetX,
                  y: -UpperPanto.targetY,
                  r: 0 // TODO
                }
              };
              ws.send(JSON.stringify(packet));
            }
            if($("#grab-lower").hasClass('active')){
              LowerPanto.targetX = -x+150;
              LowerPanto.targetY = y - 50;
              LowerPanto.inverseKinematicsNumeric(LowerPanto.targetX,LowerPanto.targetY);
              flushGlyph();
              const packet = {
                type: 'handleMoved',
                port: 'virtual0', // TODO
                index: 1,
                position: {
                  x: -LowerPanto.targetX,
                  y: -LowerPanto.targetY,
                  r: 0 // TODO
                }
              };
              ws.send(JSON.stringify(packet));
            }
          }
        }

    </script>
    <script src="js/bootstrap.min.js"></script>
  </body>
</html>
