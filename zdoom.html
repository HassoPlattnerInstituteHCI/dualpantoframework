<!DOCTYPE "html">
<html>
    <head>
        <meta charset="utf-8"/>
        <style type="text/css" media="screen">
            body {
                margin: 0px;
            }
            svg {
                width: 100%;
                height: 100%;
            }
            path {
                stroke: black;
            }
        </style>
        <script type="module">
            const svg = document.body.childNodes[1],
                  rect = svg.getBoundingClientRect(),
                  // origin = svg.getElementById('origin'),
                  player = svg.getElementById('player'),
                  enemies = svg.getElementById('enemies'),
                  walls = svg.getElementById('walls');
            let playerPos = [0, 0, 0], targetPos = [0, 0, 0], paused = 0;
            // origin.setAttribute('transform', 'translate('+(rect.width/2)+', '+(rect.height/2)+')');

            function createElement(tag, parentNode) {
                const svgElement = document.createElementNS(svg.namespaceURI, tag);
                parentNode.appendChild(svgElement);
                return svgElement;
            }

            function mapCoords(input, forward) {
                const scale = 20, originX = 500, originY = 500;
                      // originX = rect.width/2, originY = rect.height/2;
                return (forward) ? [originX+input[0]/scale, originY-input[1]/scale, input[3]] : [(input[0]-originX)*scale, (originY-input[1])*scale, input[2]];
            }

            const ws = new WebSocket('ws://' + window.location.hostname + ':' + window.location.port + window.location.pathname + window.location.search);
            ws.onopen = function(event) {
                console.log('Connection open');
            }
            ws.onclose = function(event) {
                console.log('Connection closed');
            }
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if(data.player != undefined) {
                    playerPos = mapCoords(data.pos, true);
                    player.setAttribute('transform', 'translate('+playerPos[0]+', '+playerPos[1]+') rotate('+(-playerPos[2])+')');
                } else if(data.wall != undefined) {
                    let wall = svg.getElementById('wall#'+data.wall);
                    if(!wall) {
                        const begin = mapCoords(data.begin, true), end = mapCoords(data.end, true);
                        wall = createElement('path', walls);
                        wall.setAttribute('id', 'wall#'+data.wall);
                        wall.setAttribute('d', 'M'+begin[0]+','+begin[1]+'L'+end[0]+','+end[1]);
                    }
                } else if(data.enemy != undefined) {
                    let enemy = svg.getElementById('enemy#'+data.enemy);
                    if(!enemy && data.visible) {
                        enemy = createElement('path', enemies);
                        enemy.setAttribute('id', 'enemy#'+data.enemy);
                        enemy.setAttribute('d', 'M-10,-5V5L10,0Z');
                        enemy.setAttribute('fill', 'red');
                    }
                    if(enemy && !data.visible)
                        enemies.removeChild(enemy);
                    if(enemy && data.visible) {
                        const pos = mapCoords(data.pos, true);
                        enemy.setAttribute('transform', 'translate('+pos[0]+', '+pos[1]+') rotate('+(-pos[2])+')');
                    }
                } else if(data.dead != undefined) {
                    const enemy = svg.getElementById('enemy#'+data.dead);
                    if(enemy)
                        enemies.removeChild(enemy);
                } else
                    console.log(data);
            }
            ws.onerror = function(event) {

            }

            document.body.ondblclick = function(event) {
                paused = (paused) ? 0 : 1;
                ws.send('PAUSE '+paused+'\n');
            };
            document.body.onclick = function(event) {
                targetPos[0] = event.x;
                targetPos[1] = event.y;
                ws.send(mapCoords(targetPos, false).join(' ')+'\n');
            };
            document.body.onwheel = function(event) {
                targetPos[2] += event.deltaY*0.2;
                if(targetPos[2] < -180.0)
                    targetPos[2] += 360.0;
                else if(targetPos[2] > 180.0)
                    targetPos[2] -= 360.0;
                targetPos[2] = Math.round(targetPos[2]);
                ws.send(mapCoords(targetPos, false).join(' ')+'\n');
                event.preventDefault();
            };
        </script>
    </head>
    <body>
        <svg>
            <!-- <path id="origin" d="M-10,0H10M0,-10V10" /> -->
            <path id="player" d="M-10,-5V5L10,0Z" />
            <g id="enemies"></g>
            <g id="walls"></g>
        </svg>
    </body>
</html>
